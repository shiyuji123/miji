<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>EduQA Intelligent Question Search System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- MathJax 配置 -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <!-- marked.js: 渲染 Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f3f4f6;
      color: #1f2937;
    }

    header {
      background: linear-gradient(to right, #2563eb, #3b82f6);
      padding: 1.5rem;
      color: white;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .section {
      margin-bottom: 2rem;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: block;
    }

    input[type="file"],
    textarea {
      width: 97%;
      padding: 1rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button {
      background: linear-gradient(to right, #2563eb, #3b82f6);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      opacity: 0.95;
    }

    #imagePreview {
      display: none;
      max-width: 100%;
      max-height: 300px;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    #ocrResult, #aiAnswer {
      white-space: pre-wrap;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 1.25rem;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    .loader {
      display: inline-block;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-top: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    footer {
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
      margin: 3rem 0 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>EduQA Intelligent Question Search System</h1>
    <p>Photo Search | AI Solutions | Math Formula Support</p>
  </header>

  <main class="container">
    <div class="section">
      <label for="imageInput">Upload a picture of the title:</label>
      <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)">
      <img id="imagePreview" src="" alt="Image Preview">
      <div class="button-group">
        <button onclick="submitImage()">Extract the title text</button>
        <button onclick="rescanImage()">Recertify</button>
      </div>
      <div id="ocrResultTitle" style="font-weight: bold; margin-top: 1rem;"></div>
      <div id="ocrResult"></div>
    </div>

    <div class="section">
      <label for="textInput">Manually enter or edit the title:</label>
      <textarea id="textInput" rows="6" placeholder="Please enter a title or use the recognition results above..."></textarea>
      <button onclick="submitQuestion()">Submission of questions</button>
    </div>

    <div class="section">
      <label>AI Answer:</label>
      <div id="aiAnswer"></div>
    </div>
  </main>

  <footer>
    All content generated by the Service is generated by artificial intelligence models, the accuracy and completeness of the generated content cannot be guaranteed and does not represent our attitude or views
  </footer>

  <script>
    let lastImageBlob = null;

    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        lastImageBlob = file;
        const preview = document.getElementById("imagePreview");
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      }
    }

    function submitImage(blob = null) {
      const file = blob || document.getElementById("imageInput").files[0];
      if (!file) {
        alert("Please select an image first");
        return;
      }

      const formData = new FormData();
      formData.append("image", file);
      document.getElementById("ocrResult").innerHTML = '<div class="loader"></div>';

      fetch("/upload_image", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.text) {
            document.getElementById("ocrResultTitle").innerText = "Extract content:";
            document.getElementById("ocrResult").innerText = data.text;
            document.getElementById("textInput").value = data.text;
          } else {
            document.getElementById("ocrResult").innerText = "⚠️ Failed to recognize any text.";
          }
        })
        .catch(err => {
          alert("Upload failed:" + err);
        });
    }

    function rescanImage() {
      if (lastImageBlob) {
        submitImage(lastImageBlob);
      } else {
        alert("请先选择图片");
      }
    }

    function submitQuestion() {
      const text = document.getElementById("textInput").value.trim();
      const answerDiv = document.getElementById("aiAnswer");
      if (!text) {
        alert("Please enter a question or use the recognition results above ");
        return;
      }

      answerDiv.innerHTML = '<div class="loader"></div>';

      fetch("/ask_question", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: text })
      })
        .then(res => res.json())
        .then(data => {
          if (data.answer) {
            let raw = data.answer;

            // 替换 (xxx) 为 \(xxx\)，替换 [xxx] 为 \[xxx\]
            raw = raw.replace(/\(\s*([^\(\)]+?)\s*\)/g, (_, c) => `\\(${c}\\)`);
            raw = raw.replace(/\[\s*([^\[\]]+?)\s*\]/g, (_, c) => `\\[${c}\\]`);

            marked.setOptions({ breaks: true, mangle: false, headerIds: false });
            const html = marked.parse(raw);
            answerDiv.innerHTML = html;

            if (window.MathJax) {
              MathJax.typesetPromise([answerDiv]);
            }
          } else {
            answerDiv.innerText = "⚠️ Could not get an AI answer.";
          }
        })
        .catch(err => {
          alert("Failed to submit: " + err);
        });
    }
  </script>
</body>
</html>
